<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <title>Gestão de Carnês</title>
    <script src="https://cdn.tailwindcss.com?plugins=forms"></script>
    <style>
        .modal-overlay { background-color: rgba(0, 0, 0, 0.5); backdrop-filter: blur(4px); }
        .transition-all { transition: all 0.3s ease-in-out; }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 font-sans min-h-screen">

    <header class="bg-white border-b border-gray-200 sticky top-0 z-30">
        <div class="max-w-7xl mx-auto px-4 h-16 flex items-center justify-between">
            <div class="flex items-center gap-2">
                <div class="bg-blue-600 p-2 rounded-lg">
                    <svg class="h-6 w-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"></path></svg>
                </div>
                <h1 class="text-xl font-bold text-gray-900">Gestão de Carnês</h1>
            </div>
            <div id="status-badge"></div> </div>
    </header>

    <main class="max-w-7xl mx-auto px-4 py-8">
        
        <section class="mb-8 flex justify-between items-center">
            <div>
                <h2 class="text-2xl font-semibold text-gray-800">Painel de Controle</h2>
                <p class="text-gray-500">Gerencie pagamentos e membros.</p>
            </div>
            <button onclick="toggleModal('new-carne-modal')" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2.5 rounded-lg font-medium shadow-sm flex items-center gap-2 transition-all">
                <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>
                Novo Carnê
            </button>
        </section>

        <section id="client-list-container" class="grid gap-6">
            <p class="text-gray-500 text-center py-10">Carregando membros...</p>
        </section>

    </main>

    <div id="new-carne-modal" class="fixed inset-0 z-50 hidden overflow-y-auto">
        <div class="flex items-center justify-center min-h-screen px-4">
            <div class="fixed inset-0 modal-overlay" onclick="toggleModal('new-carne-modal')"></div>
            <div class="bg-white rounded-xl shadow-xl transform transition-all sm:max-w-lg sm:w-full z-10 p-6">
                <h3 class="text-xl font-bold text-gray-900 mb-4">Novo Cadastro</h3>
                <form id="new-carne-form" class="space-y-4">
                    <input id="inp-nome" class="w-full rounded-lg border-gray-300" placeholder="Nome do Cliente" type="text" required />
                    <input id="inp-telefone" class="w-full rounded-lg border-gray-300" placeholder="Telefone" type="text" />
                    <div class="grid grid-cols-2 gap-4">
                        <input id="inp-numero" class="w-full rounded-lg border-gray-300" placeholder="Nº Carnê" type="number" required />
                        <input id="inp-valor" class="w-full rounded-lg border-gray-300" placeholder="Valor (R$)" type="number" step="0.01" />
                    </div>
                    <select id="inp-ano" class="w-full rounded-lg border-gray-300">
                        <option value="2025">2025</option>
                        <option value="2026">2026</option>
                    </select>
                    <div class="flex justify-end gap-3 pt-4">
                        <button type="button" onclick="toggleModal('new-carne-modal')" class="px-4 py-2 text-gray-700 bg-gray-100 rounded-lg">Cancelar</button>
                        <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Salvar Carnê</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div id="blocked-overlay" class="fixed inset-0 z-[100] hidden flex items-center justify-center p-4 modal-overlay">
        <div class="bg-white rounded-2xl p-8 max-w-md w-full text-center shadow-2xl border-t-4 border-red-500">
            <div class="bg-red-100 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-6">
                <svg class="h-8 w-8 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m0 0v2m0-2h2m-2 0h-2m-3-4l1.391-1.391a2 2 0 012.828 0L12 13l2.781-2.781a2 2 0 012.828 0L19 11.609M5 12V7a2 2 0 012-2h10a2 2 0 012 2v5m-14 0h14"></path></svg>
            </div>
            <h2 class="text-2xl font-bold text-gray-900 mb-2">Licença Expirada</h2>
            <p class="text-gray-600 mb-6">Renove seu acesso por apenas R$ 80,00/mês para continuar gerenciando.</p>
            <button onclick="comprarAssinatura()" id="btn-pagar" class="w-full bg-[#009EE3] hover:bg-[#0086c3] text-white font-bold py-3 rounded-lg flex items-center justify-center gap-2 shadow-lg transition-all">
                Pagar com Mercado Pago
            </button>
        </div>
    </div>

    <script>
        // --- 1. INICIALIZAÇÃO ---
        document.addEventListener('DOMContentLoaded', () => {
            verificarStatusAssinatura();
            carregarDashboard();
        });

        // --- 2. LÓGICA DE ASSINATURA ---
        async function verificarStatusAssinatura() {
            try {
                const res = await fetch('/api/status-assinatura');
                const data = await res.json();
                
                const badge = document.getElementById('status-badge');
                const overlay = document.getElementById('blocked-overlay');

                if (data.status === 'ativa') {
                    badge.innerHTML = `<span class="px-3 py-1 bg-green-100 text-green-800 text-xs font-bold rounded-full border border-green-200">Ativa (${data.dias_restantes} dias)</span>`;
                    overlay.classList.add('hidden');
                    document.body.style.overflow = 'auto';
                } else {
                    badge.innerHTML = `<span class="px-3 py-1 bg-red-100 text-red-800 text-xs font-bold rounded-full border border-red-200">Expirada</span>`;
                    overlay.classList.remove('hidden');
                    document.body.style.overflow = 'hidden';
                }
            } catch (error) { console.error('Erro ao verificar assinatura:', error); }
        }

        async function comprarAssinatura() {
            const btn = document.getElementById('btn-pagar');
            btn.innerHTML = 'Gerando Link...';
            btn.disabled = true;
            try {
                const res = await fetch('/api/criar-pagamento', { method: 'POST' });
                const data = await res.json();
                if (data.init_point) window.location.href = data.init_point;
            } catch (e) {
                alert('Erro ao conectar com Mercado Pago');
                btn.innerHTML = 'Tentar Novamente';
                btn.disabled = false;
            }
        }

        // --- 3. DASHBOARD E LISTAGEM ---
        async function carregarDashboard() {
            const container = document.getElementById('client-list-container');
            try {
                const res = await fetch('/api/dashboard');
                if (res.status === 403) return; // Bloqueado
                
                const clientes = await res.json();
                container.innerHTML = clientes.length ? '' : '<p class="text-center text-gray-500">Nenhum carnê cadastrado.</p>';

                clientes.forEach(c => {
                    const pct = Math.round((c.pagas / 12) * 100);
                    container.innerHTML += `
                        <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden mb-4">
                            <div class="p-6 cursor-pointer hover:bg-gray-50 transition-colors" onclick="carregarParcelas(${c.carne_id})">
                                <div class="flex flex-wrap items-center justify-between gap-4">
                                    <div class="flex items-center gap-4">
                                        <div class="h-10 w-10 bg-blue-100 rounded-full flex items-center justify-center text-blue-600 font-bold">${c.nome.substring(0,2).toUpperCase()}</div>
                                        <div>
                                            <h3 class="font-bold text-gray-900">${c.nome}</h3>
                                            <p class="text-sm text-gray-500">Carnê: ${c.numero_carne}</p>
                                        </div>
                                    </div>
                                    <div class="w-full md:w-1/3">
                                        <div class="flex justify-between text-xs mb-1">
                                            <span>${c.pagas}/12 Pagas</span>
                                            <span class="font-bold text-blue-600">${pct}%</span>
                                        </div>
                                        <div class="w-full bg-gray-200 rounded-full h-2">
                                            <div class="bg-blue-600 h-2 rounded-full" style="width: ${pct}%"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div id="detalhes-${c.carne_id}" class="hidden bg-gray-50 p-6 border-t border-gray-100 grid grid-cols-4 sm:grid-cols-6 md:grid-cols-12 gap-3">
                                </div>
                        </div>
                    `;
                });
            } catch (e) { console.error(e); }
        }

        async function carregarParcelas(id) {
            const container = document.getElementById(`detalhes-${id}`);
            if (!container.classList.contains('hidden')) {
                container.classList.add('hidden');
                return;
            }
            
            container.innerHTML = '<p class="col-span-12 text-center text-xs">Carregando...</p>';
            container.classList.remove('hidden');

            const res = await fetch(`/api/carne/${id}/parcelas`);
            const parcelas = await res.json();
            const meses = ['JAN','FEV','MAR','ABR','MAI','JUN','JUL','AGO','SET','OUT','NOV','DEZ'];

            container.innerHTML = parcelas.map((p, idx) => `
                <div onclick="pagarParcela(${p.id}, ${id})" class="cursor-pointer flex flex-col items-center gap-1 group">
                    <div class="w-8 h-8 rounded-full flex items-center justify-center text-xs font-bold text-white shadow-sm transition-transform group-hover:scale-110 ${p.status === 'pago' ? 'bg-green-500' : 'bg-red-400'}">
                        ${p.numero_parcela}
                    </div>
                    <span class="text-[10px] text-gray-400 font-bold">${meses[idx]}</span>
                </div>
            `).join('');
        }

        async function pagarParcela(parcelaId, carneId) {
            if (!confirm('Alterar status do pagamento?')) return;
            await fetch(`/api/parcela/${parcelaId}`, { method: 'PUT' });
            carregarParcelas(carneId); // Atualiza bolinhas
            carregarDashboard(); // Atualiza barra de progresso (reload silencioso na lista seria ideal, mas aqui recarrega tudo pra simplificar)
        }

        // --- 4. NOVO CARNÊ ---
        document.getElementById('new-carne-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = e.target.querySelector('button[type="submit"]');
            btn.disabled = true; btn.innerText = "Salvando...";

            const dados = {
                nome: document.getElementById('inp-nome').value,
                telefone: document.getElementById('inp-telefone').value,
                numero_carne: document.getElementById('inp-numero').value,
                valor: document.getElementById('inp-valor').value,
                ano: document.getElementById('inp-ano').value
            };

            try {
                const res = await fetch('/api/cadastrar', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(dados)
                });
                
                if (res.ok) {
                    toggleModal('new-carne-modal');
                    e.target.reset();
                    carregarDashboard();
                } else {
                    alert('Erro ao salvar.');
                }
            } catch (err) { alert('Erro de conexão.'); }
            
            btn.disabled = false; btn.innerText = "Salvar Carnê";
        });

        function toggleModal(id) {
            document.getElementById(id).classList.toggle('hidden');
        }
    </script>
</body>
</html>