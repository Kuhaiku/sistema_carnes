<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GestÃ£o de CarnÃªs</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        *:focus-visible { outline: 3px solid #3b82f6; outline-offset: 2px; }
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 font-sans antialiased min-h-screen">

    <div class="max-w-6xl mx-auto p-6">
        
        <header class="mb-6 flex flex-col md:flex-row justify-between items-center gap-4">
            <div>
                <h1 class="text-3xl font-bold text-blue-700">DoaFÃ¡cil</h1>
                <p class="text-sm text-gray-500 mt-1">GestÃ£o de CarnÃªs de DoaÃ§Ã£o</p>
            </div>
            <div class="w-full md:w-1/3">
                <input type="text" id="busca" placeholder="Buscar por nome ou nÂº do carnÃª..." class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:border-blue-500 focus:ring-1 focus:ring-blue-500 shadow-sm" oninput="renderizarCarnes()">
            </div>
        </header>

        <section class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8">
            <div class="bg-white p-5 rounded-xl border border-gray-200 shadow-sm flex items-center justify-between">
                <div><p class="text-sm text-gray-500 font-medium">Total Arrecadado</p><p class="text-2xl font-bold text-green-600" id="totalValor">R$ 0,00</p></div>
                <div class="bg-green-100 p-3 rounded-lg text-green-600">ðŸ’°</div>
            </div>
            <div class="bg-white p-5 rounded-xl border border-gray-200 shadow-sm flex items-center justify-between">
                <div><p class="text-sm text-gray-500 font-medium">Folhas Pagas</p><p class="text-2xl font-bold text-blue-600" id="totalFolhas">0</p></div>
                <div class="bg-blue-100 p-3 rounded-lg text-blue-600">ðŸ“„</div>
            </div>
            <div class="bg-white p-5 rounded-xl border border-gray-200 shadow-sm flex items-center justify-between">
                <div><p class="text-sm text-gray-500 font-medium">CarnÃªs Ativos</p><p class="text-2xl font-bold text-purple-600" id="totalCarnes">0</p></div>
                <div class="bg-purple-100 p-3 rounded-lg text-purple-600">ðŸ“š</div>
            </div>
        </section>

        <section class="bg-white p-6 rounded-xl shadow-sm border border-gray-200 mb-8">
            <h2 class="text-lg font-semibold mb-4 border-b pb-2">Novo CarnÃª</h2>
            <form id="formCadastro" class="grid grid-cols-1 md:grid-cols-3 gap-4 items-end">
                <div class="flex flex-col">
                    <label for="nome" class="text-sm font-medium text-gray-700 mb-1">Nome do Doador</label>
                    <input type="text" id="nome" required class="px-4 py-2 border border-gray-300 rounded-lg focus:border-blue-500 focus:ring-1 focus:ring-blue-500">
                </div>
                <div class="flex flex-col">
                    <label for="telefone" class="text-sm font-medium text-gray-700 mb-1">Telefone</label>
                    <input type="tel" id="telefone" required class="px-4 py-2 border border-gray-300 rounded-lg focus:border-blue-500 focus:ring-1 focus:ring-blue-500">
                </div>
                <div class="flex flex-col">
                    <label for="numCarne" class="text-sm font-medium text-gray-700 mb-1">NÂº do CarnÃª</label>
                    <div class="flex gap-2">
                        <input type="text" id="numCarne" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:border-blue-500 focus:ring-1 focus:ring-blue-500">
                        <button type="submit" id="btnGerar" class="bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-6 rounded-lg shadow-sm transition-colors">Gerar</button>
                    </div>
                </div>
            </form>
        </section>

        <section>
            <div id="listaCarnes" class="grid grid-cols-1 gap-6 mb-20"></div>
        </section>
    </div>

    <script>
        let bdCarnes = [];
        const formatarMoeda = (valor) => Number(valor).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });

        // --- INTEGRAÃ‡ÃƒO COM A API ---

        async function carregarDados() {
            try {
                const response = await fetch('/api/carnes');
                bdCarnes = await response.json();
                atualizarDashboard();
                renderizarCarnes();
            } catch (error) {
                console.error("Erro ao carregar dados", error);
            }
        }

        document.getElementById('formCadastro').addEventListener('submit', async function(e) {
            e.preventDefault();
            const btn = document.getElementById('btnGerar');
            btn.disabled = true;
            btn.textContent = 'Gerando...';

            const payload = {
                nome: document.getElementById('nome').value,
                telefone: document.getElementById('telefone').value,
                numero: document.getElementById('numCarne').value
            };

            try {
                const response = await fetch('/api/carnes', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                if (!response.ok) throw new Error(await response.text());
                
                this.reset();
                await carregarDados(); 
            } catch (error) {
                alert("Erro: " + error.message);
            } finally {
                btn.disabled = false;
                btn.textContent = 'Gerar';
            }
        });

        async function excluirCarne(id) {
            if (!confirm("Tem certeza que deseja excluir este carnÃª?")) return;
            try {
                await fetch(`/api/carnes/${id}`, { method: 'DELETE' });
                await carregarDados();
            } catch (error) {
                alert("Erro ao excluir.");
            }
        }

        async function confirmarPagamento(carneId, indexFolha) {
            const input = document.getElementById(`input-valor-${carneId}`);
            const valor = parseFloat(input.value);

            if (!valor || valor <= 0) {
                alert("Insira um valor vÃ¡lido.");
                input.focus();
                return;
            }

            try {
                await fetch(`/api/carnes/${carneId}/folhas/${indexFolha}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ valor })
                });
                await carregarDados();
            } catch (error) {
                alert("Erro ao processar pagamento.");
            }
        }

        // --- CONTROLE DE INTERFACE ---

        function atualizarDashboard() {
            let totalArrecadado = 0, folhasPagas = 0;
            bdCarnes.forEach(carne => carne.folhas.forEach(f => {
                if (f.paga) { totalArrecadado += f.valor; folhasPagas++; }
            }));
            document.getElementById('totalValor').textContent = formatarMoeda(totalArrecadado);
            document.getElementById('totalFolhas').textContent = folhasPagas;
            document.getElementById('totalCarnes').textContent = bdCarnes.length;
        }

        function toggleExpandir(id) {
            const carne = bdCarnes.find(c => c.id === id);
            if (carne) { carne.expandido = !carne.expandido; renderizarCarnes(); }
        }

        function abrirInputInline(carneId, indexFolha) {
            const carne = bdCarnes.find(c => c.id === carneId);
            if (carne) { 
                carne.folhaAtiva = indexFolha; 
                renderizarCarnes(); 
                // DÃ¡ foco e seleciona o texto no input automaticamente ao abrir
                setTimeout(() => {
                    const input = document.getElementById(`input-valor-${carneId}`);
                    if(input) {
                        input.focus();
                        input.select();
                    }
                }, 50);
            }
        }

        function cancelarInputInline(carneId) {
            const carne = bdCarnes.find(c => c.id === carneId);
            if (carne) { carne.folhaAtiva = null; renderizarCarnes(); }
        }

        function renderizarCarnes() {
            const termoBusca = document.getElementById('busca').value.toLowerCase();
            const lista = document.getElementById('listaCarnes');
            lista.innerHTML = '';

            const filtrados = bdCarnes.filter(c => c.nome.toLowerCase().includes(termoBusca) || c.numero.includes(termoBusca));
            if (filtrados.length === 0) { lista.innerHTML = `<p class="text-gray-500 text-center py-4">Nenhum carnÃª encontrado.</p>`; return; }

            filtrados.forEach(carne => {
                let folhasHTML = '';
                
                carne.folhas.forEach(folha => {
                    const isAtiva = carne.folhaAtiva === folha.index;
                    
                    if (folha.paga) {
                        // Folha jÃ¡ paga - agora Ã© um botÃ£o clicÃ¡vel para ediÃ§Ã£o
                        const classPagaAtiva = isAtiva ? 'border-blue-500 bg-blue-50 ring-2 ring-blue-500' : 'border-green-300 bg-green-50 hover:bg-green-100 hover:border-green-400';
                        
                        folhasHTML += `
                            <button onclick="abrirInputInline(${carne.id}, ${folha.index})" class="relative border ${classPagaAtiva} rounded-lg p-2 flex flex-col items-center justify-center transition-colors cursor-pointer h-16 w-full group text-left">
                                <span class="absolute top-1 right-1 text-green-600 opacity-0 group-hover:opacity-100 transition-opacity ${isAtiva ? 'text-blue-500 opacity-100' : ''}">
                                    <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"></path></svg>
                                </span>
                                <span class="text-xs font-bold ${isAtiva ? 'text-blue-700' : 'text-green-700'}">Folha ${folha.index}</span>
                                <span class="text-sm font-semibold ${isAtiva ? 'text-blue-600' : 'text-green-600'} break-all">${formatarMoeda(folha.valor)}</span>
                            </button>`;
                    } else {
                        // Folha a receber
                        const classPendenteAtiva = isAtiva ? 'border-blue-500 bg-blue-50 ring-2 ring-blue-500' : 'border-gray-200 hover:border-blue-400 hover:bg-blue-50';
                        
                        folhasHTML += `
                            <button onclick="abrirInputInline(${carne.id}, ${folha.index})" class="border ${classPendenteAtiva} rounded-lg p-2 flex flex-col items-center justify-center transition-colors cursor-pointer h-16 w-full group text-left">
                                <span class="text-xs font-medium ${isAtiva ? 'text-blue-600 font-bold' : 'text-gray-500 group-hover:text-blue-600'}">Folha ${folha.index}</span>
                                <span class="text-xs ${isAtiva ? 'text-blue-500' : 'text-gray-400'} mt-1">Receber</span>
                            </button>`;
                    }
                });

                // Bloco Inline de Pagamento
                let blocoPagamento = '';
                if (carne.folhaAtiva) {
                    // Procura os dados da folha que estÃ¡ a ser editada/recebida
                    const folhaAtivaObj = carne.folhas.find(f => f.index === carne.folhaAtiva);
                    const isEdicao = folhaAtivaObj && folhaAtivaObj.paga;
                    const valorAtual = isEdicao ? folhaAtivaObj.valor : '';
                    const textoBotao = isEdicao ? 'Atualizar' : 'Salvar';

                    blocoPagamento = `
                        <div class="mt-4 p-4 border border-blue-200 bg-blue-50 rounded-lg flex flex-col sm:flex-row items-center justify-between gap-4 transition-all shadow-inner">
                            <span class="text-blue-800 font-medium">${isEdicao ? 'Editar valor da:' : 'LanÃ§ar valor para:'} <strong class="text-blue-900">Folha nÃºmero ${carne.folhaAtiva}</strong></span>
                            <div class="flex items-center gap-2 w-full sm:w-auto">
                                <div class="relative w-full sm:w-40">
                                    <span class="absolute left-3 top-2 text-gray-500">R$</span>
                                    <input type="number" id="input-valor-${carne.id}" value="${valorAtual}" class="w-full pl-9 py-2 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500 outline-none bg-white" placeholder="0.00" step="0.01">
                                </div>
                                <button onclick="confirmarPagamento(${carne.id}, ${carne.folhaAtiva})" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded font-medium transition-colors">${textoBotao}</button>
                                <button onclick="cancelarInputInline(${carne.id})" class="bg-white border border-gray-300 hover:bg-gray-100 text-gray-700 px-3 py-2 rounded transition-colors">âœ•</button>
                            </div>
                        </div>
                    `;
                }

                const chevronIcon = carne.expandido 
                    ? '<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7" /></svg>' 
                    : '<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" /></svg>'; 

                lista.innerHTML += `
                    <div class="bg-white border border-gray-200 rounded-xl p-5 shadow-sm transition-all">
                        <div class="flex justify-between items-start mb-4 border-b pb-3">
                            <div>
                                <h3 class="text-lg font-bold text-gray-800">${carne.nome}</h3>
                                <p class="text-sm text-gray-500 mt-1 flex items-center gap-1">
                                    <svg class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z" /></svg>
                                    ${carne.telefone}
                                </p>
                            </div>
                            <div class="flex items-center gap-2">
                                <span class="bg-blue-100 text-blue-800 text-sm font-bold px-3 py-1 rounded-md border border-blue-200 mr-2">CarnÃª NÂº ${carne.numero}</span>
                                <button onclick="excluirCarne(${carne.id})" class="p-1 text-red-500 hover:bg-red-50 rounded-full transition-colors" title="Excluir"><svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg></button>
                                <button onclick="toggleExpandir(${carne.id})" class="p-1 hover:bg-gray-100 rounded-full transition-colors">${chevronIcon}</button>
                            </div>
                        </div>
                        <div class="${carne.expandido ? 'block' : 'hidden'}">
                            <div class="grid grid-cols-3 sm:grid-cols-4 md:grid-cols-6 lg:grid-cols-12 gap-2">
                                ${folhasHTML}
                            </div>
                            ${blocoPagamento}
                        </div>
                    </div>`;
            });
        }

        carregarDados();
    </script>
</body>
</html>
